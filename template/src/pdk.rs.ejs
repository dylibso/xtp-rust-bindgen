// THIS FILE WAS GENERATED BY `xtp-rust-bindgen`. DO NOT EDIT.

#![allow(non_snake_case)]
#![allow(unused_macros)]
use extism_pdk::*;

fn panic_if_key_missing() -> ! {
  panic!("missing key");
}

pub(crate) mod internal {
    pub(crate) fn return_error(e: extism_pdk::Error) -> i32 {
        let err = format!("{:?}", e);
        let mem = extism_pdk::Memory::from_bytes(&err).unwrap();
        unsafe {
            extism_pdk::extism::error_set(mem.offset());
        }
        -1
    }
}

#[allow(unused)]
macro_rules! try_input {
    () => {{
        let x = extism_pdk::input();
        match x {
            Ok(x) => x,
            Err(e) => return internal::return_error(e),
        }
    }}
}

#[allow(unused)]
macro_rules! try_input_json {
    () => {{
        let x = extism_pdk::input();
        match x {
            Ok(extism_pdk::Json(x)) => x,
            Err(e) => return internal::return_error(e),
        }
    }}
}

use base64_serde::base64_serde_type;

base64_serde_type!(Base64Standard, base64::engine::general_purpose::STANDARD);


mod exports {
    use super::*;
<% schema.exports.forEach(ex => { -%>

#[no_mangle]
pub extern "C" fn <%- ex.name %>() -> i32 {
    <% if (ex.output && isJsonEncoded(ex.output)) { %>
    let ret = crate::<%- formatIdentifier(ex.name) %>(<% if (ex.input) { %>  <% if (isJsonEncoded(ex.input)) { %> try_input_json!() <% } else { %> try_input!() <% } %> <% } %>).and_then(|x| extism_pdk::output(extism_pdk::Json(x)));
    <% } else { %>
    let ret = crate::<%- formatIdentifier(ex.name) %>(<% if (ex.input) { %> <% if (isJsonEncoded(ex.input)) { %> try_input_json!() <% } else { %> try_input!() <% } %> <% } %>).and_then(extism_pdk::output);
    <% } %>
    match ret {
        Ok(()) => {
            0
        }
        Err(e) => {
            internal::return_error(e)
        }
    }
}
<% }) %>
}

pub mod types {
    use super::*;
<% Object.values(schema.schemas).forEach(schema => { %>
    <% if (isEnum(schema)) { %>
#[derive(Default, serde::Serialize, serde::Deserialize, extism_pdk::FromBytes, extism_pdk::ToBytes)]
#[encoding(Json)]
pub enum <%- capitalize(schema.name) %> {
    #[default]
    <% schema.xtpType.values.forEach(variant => { -%>
    #[serde(rename = "<%- variant %>")]
    <%- capitalize(variant) %>,
		<% }) %>
}
    <% } else { %>
#[derive(Default, serde::Serialize, serde::Deserialize, extism_pdk::FromBytes, extism_pdk::ToBytes)]
#[encoding(Json)]
pub struct <%- capitalize(schema.name) %> {
    <% schema.properties.forEach(p => { -%>
    <% let propType = toRustType(p, p.required) %>
		<% if (p.description) { -%>
		/// <%- formatCommentBlock(p.description, "/// ") %>
		<% } -%>
    #[serde(rename = "<%- p.name %>")]
    <% if (isOptional(propType)) { %>
      <% if (!p.required) { %>
   #[serde(skip_serializing_if="Option::is_none")]
   #[serde(default = "panic_if_key_missing")]
      <% } else { %>
    #[serde(default)]
      <% } %>
    <% } %>
    <% if (isBuffer(p)) { %> #[serde(with = "Base64Standard")] <% } %>
		pub <%- formatIdentifier(p.name) %>: <%- propType %>,
		<% }) %>
}
    <% } %>
<% }); %>
}

mod raw_imports {
    use super::*;
    #[host_fn]
    extern "ExtismHost" {
<% schema.imports.forEach(imp => { %>
        pub(crate) fn <%- imp.name %>(<% if (imp.input) { -%>input: <% if (isJsonEncoded(imp.input)) { %><%- jsonWrappedRustType(imp.input) %><%} else {%> <%- toRustType(imp.input) %> <%}%><%} -%>) <% if (imp.output) { -%> -> <% if (isJsonEncoded(imp.output)) {%> <%- jsonWrappedRustType(imp.output) %> <%} else {%> <%-toRustType(imp.output) %> <%}%><% } -%>;
<% }) %>
    }
}

<% schema.imports.forEach(imp => { %>
<% if (hasComment(imp)) -%>
/// <%- imp.name %> <%- formatCommentBlock(imp.description, "/// ") %>
<% if (hasComment(imp.input)) { -%>
/// It takes input of <%- toRustType(imp.input) %> (<%- formatCommentLine(imp.input.description) %>)
<% } -%>
<% if (hasComment(imp.output)) { -%>
/// And it returns an output <%- toRustType(imp.output) %> (<%- formatCommentLine(imp.output.description) %>)
<% } -%>
#[allow(unused)]
pub(crate) fn <%- formatIdentifier(imp.name) %>(<% if (imp.input) { -%>input: <%- toRustType(imp.input) %><%} -%>) -> std::result::Result<<% if (imp.output) { -%><%- toRustType(imp.output) %><% } else { -%> () <% } %> , extism_pdk::Error>  {
    let res = unsafe {
        raw_imports::<%- imp.name %>(
            <% if (imp.input) { %> <% if (isJsonEncoded(imp.input)) { %> extism_pdk::Json(input) <%} else {%> input <%}%> <% } %>
        )?
    };

    <% if (imp.output && isJsonEncoded(imp.output)) { %> 
    let extism_pdk::Json(res) = res;
    <% } %>

    Ok(res)
}
<% }) %>
